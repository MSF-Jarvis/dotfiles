#!/usr/bin/env bash

# SPDX-License-Identifier: GPL-3.0-only #

# Source common functions
SCRIPT_DIR="$(cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd)"
source "${SCRIPT_DIR}/common"
source "${SCRIPT_DIR}/gitshit"
source "${SCRIPT_DIR}/apps"
source "${SCRIPT_DIR}/aliases"

function reload {
    source ~/.bashrc
}

function lolsay {
    cowsay "${@}" | lolcat
}

function foreversay {
    until ! lolsay "${@}";do sleep 0;done
}

function cpuinfo {
    grep -E '^model name|^cpu MHz' /proc/cpuinfo
}

function battinfo {
    local BASE=/sys/class/power_supply/BAT0/
    declare -a ITEMS=("capacity_level:Battery_status" "charge_now:Current_charge" "capacity:Battery_percentage" "status:Status")
    for ITEM in "${ITEMS[@]}"; do
        NODE=$(echo "${ITEM}" | cut -d ':' -f 1)
        LABEL=$(echo "${ITEM}" | cut -d ':' -f 2)
        echo -e "${CL_RED}${LABEL/_/ }${CL_RST}: ${CL_YLW}$(cat "${BASE}${NODE}")${CL_RST}"
    done
}

# Server tooling
function serverconnect {
    ssh horbis@aosiprom.com
}

function backup {
    adb-sync --reverse /sdcard/* ~/git-repos/backups/
}

# Random utility tooling
function weather {
    if [ "$(tput cols)" -lt 125 ]; then # 125 is min size for correct display
        if [ -z "$1" ]; then
            curl "wttr.in/Ghaziabad?0"
        else
            curl "wttr.in/~$1?0"
        fi
    else
        if [ -z "$1" ]; then
            curl "wttr.in/Ghaziabad"
        else
            curl "wttr.in/~$1"
        fi
    fi
}

function reboot {
  echo "Do you really wanna reboot??"
  read confirmation
  case "${confirmation}" in
      'y'|'Y') exec "$(command -v reboot)" ;;
      *) ;;
  esac
}

function tab2space() {
  find . -type f -exec bash -c 'expand -t 4 "$0" > /tmp/e && mv /tmp/e "$0"' {} \;
}

function d2u() {
  find . -type f -not -iwholename '.git' -exec dos2unix {} \;
}

function whitespace() {
  find . -type f -not -iwholename '.git' -print0 | xargs -0 perl -pi -e 's/ +$//'
}

# Kernel stuff
function kgrep {
    find . -name .git -prune -o -path ./out -prune -o -regextype posix-egrep \
        -iregex '(.*\/Makefile|.*\/Kconfig|.*\/oneplus3_defconfig|.*\/caesium_defconfig|.*\/wahoo_defconfig)' -type f \
        -exec grep --color -n "$@" {} +
}

function apply_patches {
    local KERN_VER="3.18"
    [ -z "${1}" ] || KERN_VER="${1}"
    local PATCH_DIR="../stable-queue/queue-${KERN_VER}"
    grep -v '^ *#' < "${PATCH_DIR}/series" | while IFS= read -r patch
    do
        git am ~/git-repos/halogenOS/stable-queue/queue-"${KERN_VER}"/"${patch}"
    done
}

function stableprep {
    local JOBS
    JOBS="-j$(nproc --all)"
    ARCH=x86_64 make x86_64_defconfig "${JOBS}"
    make prepare "${JOBS}"
    make allyesconfig
    find "${1:?}" -name "*.o" -exec rm -v {} \;
}

function flasherThingy {
    cd ~/Downloads/walleye
    for file in $(adb-walleye shell ls /sdcard/Download/FlashKernel-Walleye-"${1}"-*.img);do
        partition=$(echo "${file}" | cut -d '-' -f 5 | sed 's/\.img//')
        reportWarning "Pulling ${file}"
        if [[ "${partition}" == "boot" ]];then
            adb-walleye pull /sdcard/MagiskManager/patched_boot.img "$(basename "${file}")"
        else
         adb-walleye pull /sdcard/Download/"$(basename "${file}")"
        fi
    done
    read -n 1 -s -r -p "Press any key to continue..."
    reportWarning "Rebooting to bootloader"
    adb-walleye reboot bootloader
    sleep 5
    for file in FlashKernel-Walleye-${1}-*.img
    do
        partition=$(echo "${file}" | cut -d '-' -f 5 | sed 's/\.img//')
        fastboot flash "${partition}" "${file}"
    done
    echoText "Flashing complete, rebooting"
    fastboot reboot
}


function findJ {
    ag -ia "${1}" | grep java | cut -f 1 -d ':' | uniq
}

function fao {
    if [ -z "${1}" ]; then
        echoText "Supply a filename moron"
        return
    else
        local SEARCH_DIR
        SEARCH_DIR="."
        [ -z "${2}" ] || SEARCH_DIR="${2}"
        nano -L "$(find "${SEARCH_DIR}" -name "${1}.*")"
    fi
}

function night {
    exesudo "echo 1 > /sys/class/backlight/intel_backlight/brightness"
    sudo pkill xflux # In case it's already running. Erring on the side of caution here.
    xflux -l 28.6869 -g 77.3525 -r 1 -k 2000
}