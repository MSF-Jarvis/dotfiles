#!/usr/bin/env bash

# Copyright (C) Harsh Shandilya <msfjarvis@gmail.com>
# SPDX-License-Identifier: GPL-3.0-only

# Source common functions
# shellcheck disable=2029
SCRIPT_DIR="$(cd "$( dirname "$( readlink -f "${BASH_SOURCE[0]}" )" )" && pwd)"
source "${SCRIPT_DIR}"/common

[ -f ".buildconfig" ] && source ".buildconfig"
[ -z "${DEFCONFIG}" ] && DEFCONFIG="caesium_defconfig"
[ -z "${KERNEL}" ] && KERNEL="Image.gz-dtb"
TREES="rr:pie|aosip:pie"
JARVISBOX_URL="https://download.msfjarvis.website/caesium"

# Caesium Kernel Details
KERNEL_NAME="Caesium"
INCREMENTAL_VERSION="${CAESIUM_VERSION:-Test}"
LOCALVERSION="-${INCREMENTAL_VERSION}"
GIT_HASH=$(git rev-parse --short HEAD)
[ -z "${DEVICE}" ] && DEVICE="oneplus3"
FINAL_VER="${KERNEL_NAME}-${DEVICE}-${INCREMENTAL_VERSION}"

# Vars
ARCH=arm64
SUBARCH=arm64
USER=MSF
HOST=jarvisbox

# Paths
WORKING_DIR=$(pwd)
[ -z "${ANYKERNEL_DIR}" ] && ANYKERNEL_DIR="${WORKING_DIR}/../AnyKernel2"
[ -z "${ARM64_TOOLCHAIN_DIR}" ] && ARM64_TOOLCHAIN_DIR="${WORKING_DIR}/../toolchains/aarch64-linux-gnu"
[ -z "${ARM64_TOOLCHAIN_SEARCH_STRING}" ] && ARM64_TOOLCHAIN_SEARCH_STRING="*gnu-gcc"
[ -z "${ARM_TOOLCHAIN_DIR}" ] && ARM_TOOLCHAIN_DIR="${WORKING_DIR}/../toolchains/arm-linux-gnueabi"
[ -z "${ARM_TOOLCHAIN_SEARCH_STRING}" ] && ARM_TOOLCHAIN_SEARCH_STRING="*gnueabi-gcc"
OUT_DIR="${WORKING_DIR}/out/"
ZIP_MOVE="${WORKING_DIR}/zips/"

# Trap to bail out properly
trap 'exit 1' SIGINT SIGTERM

## Functions
# Wrapper around tgm to avoid having to pass the second chat ID param everywhere
function tgm_caesium {
    [ -z "${TYPE}" ] && return
    if [ "${TYPE}" == "test" ] || [ "${TYPE}" == "alpha" ]; then
        tgm "${1}" &
    elif [ ! -z "${TYPE}" ]; then
        tgm "${1}" "${OP3_CAESIUM_CHAT_ID}" &
    fi
}

# Wrapper function around make to ensure all the variables go through
function make_wrapper {
    if [ ! "${VERBOSE}" ]; then
        make O="${OUT_DIR}" \
            ARCH="${ARCH}" SUBARCH="${SUBARCH}" \
            KBUILD_BUILD_USER="${USER}" \
            KBUILD_BUILD_HOST="${HOST}" \
            LOCALVERSION="${LOCALVERSION}" \
            CROSS_COMPILE="${CROSS_COMPILE}" \
            CROSS_COMPILE_ARM32="${CROSS_COMPILE_ARM32}" \
            -j"$(nproc --all)" "${@}" |& ag "error:|warning"
    else
        make O="${OUT_DIR}" \
            ARCH="${ARCH}" SUBARCH="${SUBARCH}" \
            KBUILD_BUILD_USER="${USER}" \
            KBUILD_BUILD_HOST="${HOST}" \
            LOCALVERSION="${LOCALVERSION}" \
            CROSS_COMPILE="${CROSS_COMPILE}" \
            CROSS_COMPILE_ARM32="${CROSS_COMPILE_ARM32}" \
            -j"$(nproc --all)" "${@}"
    fi
}

# Pushes a local file to my webserver
function publish {
    local TYPE
    TYPE="${2:?}"
    if [ "${DEVICE}" != "oneplus3" ]; then
        TYPE=".personal"
    fi
    rsync -avR "${1}" "${CAESIUM_UPLOAD_HOST}:${CAESIUM_UPLOAD_PATH}/${TYPE}/" --progress --verbose
}

# Preps the server folder structure for new builds
function prepdirs {
    ssh "${CAESIUM_UPLOAD_HOST}" mkdir -p "${CAESIUM_UPLOAD_PATH}/${1}/"
    ssh "${CAESIUM_UPLOAD_HOST}" mkdir -p "${CAESIUM_UPLOAD_PATH/caesium/archive}/${1}/"
    ssh "${CAESIUM_UPLOAD_HOST}" rm -rf "${CAESIUM_UPLOAD_PATH/caesium/archive}/${1}/*"
    ssh "${CAESIUM_UPLOAD_HOST}" mv "${CAESIUM_UPLOAD_PATH}/${1}/*" "${CAESIUM_UPLOAD_PATH/caesium/archive}/${1}/"
}

# The meat of the telegram notifications workflow
function pushcaesiumtg {
    [ -z "${TYPE}" ] && return
    local FILE="${1}"
    local TYPE="${2}"
    local FINAL_VER="${FILE/.zip/}"
    local FILES_TO_PUBLISH=("${FILE}" "${FILE}".md5sum changelog)
    case "${TYPE}" in
        "alpha"|"beta"|"stable"|"test") ;;
        *) echo "Invalid build type" && return ;;
    esac
    cp changelog zips/changelog
    cd zips || return; md5sum "${FILE}" > "${FILE}".md5sum
    prepdirs "${TYPE}"
    if [ "${TYPE}" == "stable" ]; then
        for ITEM in beta test alpha; do
            prepdirs "${ITEM}"
        done
    fi
    for ITEM in "${FILES_TO_PUBLISH[@]}"; do
        publish "${ITEM}" "${TYPE}"
    done
    cd ../ || return
    if [ "${TYPE}" == "stable" ]; then
      release "${FILE}"
    fi
    local MESSAGE CHANGELOG BUILD_URL
    BUILD_URL="${JARVISBOX_URL}/${TYPE}/${FILE}"
    if [ "${DEVICE}" != "oneplus3" ]; then
       BUILD_URL="${JARVISBOX_URL}/.personal/${FILE}"
    fi
    MESSAGE="New [${TYPE}](${JARVISBOX_URL}/${TYPE}) build uploaded : [${FILE}](${BUILD_URL})"
    CHANGELOG="$(cat changelog 2>/dev/null)"
    if [ "${CHANGELOG}" != "" ]; then
        MESSAGE="${MESSAGE}

Changelog:

\`${CHANGELOG}\`"
    fi
        tgm_caesium " ${MESSAGE}"
}

# Called by pushcaesiumtg on release builds
function release {
    local TAG; TAG=$(echo "${1}" | cut -d / -f 2 | cut -d '-' -f 3 | sed 's/\.zip//')
    tgm_caesium "Tagging and releasing ${TAG}"
    git -C ../AnyKernel2/ push origin HEAD:8.1.x-caesium
    git -C ../AnyKernel2/ tag -s "${TAG}"
    git -C ../AnyKernel2/ push origin "${TAG}"
    git checkout XOS-8.1
    git merge staging
    git push origin XOS-8.1
    git tag -as "${TAG}"
    git push origin "${TAG}"
    hub release create "${TAG}" -a zips/"${FILE}" -a zips/"${FILE}".md5sum
    update_source_trees "${TAG}"
}

# Takes a predefined list of trees to merge into and
# programmatically updates them to the latest tag.
function update_source_trees {
    local TAG="${1}"
    IFS='|' read -r -a MERGEABLES <<< "${TREES}"
    for ITEM in "${MERGEABLES[@]}"; do
        IFS=':' read -r -a ELEMENTS <<< "${ITEM}"
        if [ "${#ELEMENTS[@]}" -ge 2 ]; then
            REMOTE="${ELEMENTS[0]}"
            BRANCH="${ELEMENTS[1]}"
            git fetch "${REMOTE}" "${BRANCH}" --no-tags
            git checkout "${BRANCH}"
            git merge "${TAG}" --no-edit --signoff
            git push "${REMOTE}" "${BRANCH}"
        fi
    done
    git checkout XOS-8.1
}

# Find the correct CROSS_COMPILE candidate
function check_toolchain() {
    local TC; TC="$(find "${ARM64_TOOLCHAIN_DIR}"/bin -name "${ARM64_TOOLCHAIN_SEARCH_STRING}")";
    if [ -f "${TC}" ]; then
        CROSS_COMPILE="${ARM64_TOOLCHAIN_DIR}/bin/$(echo "${TC}" | awk -F '/' '{print $NF}' | sed -e 's/gcc//')";
        echoText "Using toolchain: $("${CROSS_COMPILE}"gcc --version | head -1)"
        CROSS_COMPILE="$(command -v ccache) ${CROSS_COMPILE}"
    else
        reportError "No suitable toolchain found in ${ARM64_TOOLCHAIN_DIR}";
    fi
    TC="$(find "${ARM_TOOLCHAIN_DIR}"/bin -name "${ARM_TOOLCHAIN_SEARCH_STRING}")";
    if [ -f "${TC}" ]; then
        CROSS_COMPILE_ARM32="${ARM_TOOLCHAIN_DIR}/bin/$(echo "${TC}" | awk -F '/' '{print $NF}' | sed -e 's/gcc//')";
        echoText "Using toolchain: $("${CROSS_COMPILE_ARM32}gcc" --version | head -1)"
        CROSS_COMPILE_ARM32="$(command -v ccache) ${CROSS_COMPILE_ARM32}"
    else
        reportError "No suitable toolchain found in ${ARM_TOOLCHAIN_DIR}";
    fi
}

# Duh
function make_kernel {
    local RETURN_VAL
    tgm_caesium "Building \`${FINAL_VER}\`"
    mkdir -p "${OUT_DIR}"
    find "${OUT_DIR}" -name Image.gz-dtb -exec rm -rf {} \;
    make_defconfig
    if [ "${MODULE}" ]; then
        make_wrapper "${MODULE}"
    else
        make_wrapper "${KERNEL}"
    fi
    RETURN_VAL="$?"
    local BUILT_KERNEL=out/arch/"${ARCH}"/boot/"${KERNEL}"
    if [ -f "${BUILT_KERNEL}" ]; then
      cp -r "${BUILT_KERNEL}" "${ANYKERNEL_DIR}"
      return 0
    elif [ ! -z "${MODULE}" ] && [ "${RETURN_VAL}" == 0 ]; then
        echo ''
    else
      reportError "Kernel compilation failed"
      tgm "Build failed"
      exit 1
    fi
}

# Called by make_kernel, used to trap defconfig regen events
function make_defconfig {
    [ "${CLEAN}" ] && rm -rf "${OUT_DIR}"
    make_wrapper "${DEFCONFIG}" 1>/dev/null 2>&1
    if [ "${REGEN_DEFCONFIG}" ]; then
        make_wrapper savedefconfig 1>/dev/null 2>&1
        cp "${OUT_DIR}"/defconfig arch/"${ARCH}"/configs/"${DEFCONFIG}"
        echoText "Regenerated defconfig successfully"
        exit 0
    fi
}

# Create the final ZIP
function make_zip {
    local UNSIGNED_ZIP="${FINAL_VER}"_unsigned.zip
    local SIGNED_ZIP="${FINAL_VER}".zip
    cd "${ANYKERNEL_DIR}" || return
    echo "${FINAL_VER}" > version
    rm ./*.zip 2>/dev/null
    zip -r "${UNSIGNED_ZIP}" ./* -x ".git/*" "README.md" ".gitignore" "*.zip" 1>/dev/null 2>&1
    [ -z "${KEYSTORE_PASSWORD}" ] || echo "${KEYSTORE_PASSWORD}" | jarsigner -keystore "${SCRIPT_DIR}"/caesium_release.keystore "${UNSIGNED_ZIP}" msfjarvis
    mv "${UNSIGNED_ZIP}" "${SIGNED_ZIP}"
    mkdir -p "${ZIP_MOVE}"
    mv  "${SIGNED_ZIP}" "${ZIP_MOVE}"/
    cd "${WORKING_DIR}" || return
}

while getopts ":bcd:m:rt:v" OPT; do
    case "${OPT}" in
        b) echoText " Building ZIP only " >&2; ONLY_ZIP=true ;;
        c) echoText " Building clean " >&2; CLEAN=true ;;
        d)
        DEVICE="${OPTARG}"
        ANYKERNEL_DIR="${WORKING_DIR}/../AnyKernel2_${DEVICE}"
        FINAL_VER="${KERNEL_NAME}"-"${DEVICE}"-"${INCREMENTAL_VERSION}"
        ;;
        m)
        MODULE="${OPTARG}"
        [[ "${MODULE}" == */ ]] || MODULE="${MODULE}"/
        if [ ! "$(ls "${MODULE}"Kconfig*  2>/dev/null)" ]; then
            reportError "Invalid module specified - ${MODULE}"
            return 1
        fi
        echoText "Building module ${MODULE}"
        ;;
        r) echoText " Regenerating defconfig " >&2; REGEN_DEFCONFIG=true ;;
        t)
        TYPE="${OPTARG}"
        if [ "${TYPE}" != "stable" ]; then
            echoText " Setting test build parameters" >&2
            TEST_BUILD=true
            export LOCALVERSION=-"${INCREMENTAL_VERSION}"-"${GIT_HASH}"
        fi
        ;;
        v) VERBOSE=true ;;
        \?)
        reportWarning "Invalid option: -${OPTARG}" >&2
        ;;
    esac
done

[ "${TEST_BUILD}" ] && FINAL_VER="${FINAL_VER}"-"$(date +%Y%m%d-%H%M%S)"

DATE_START=$(date +"%s")

# Make
rm "${FINAL_VER}".zip 2>/dev/null
check_toolchain
if [ "${ONLY_ZIP}" ] && [ -z "${MODULE}" ]; then
    make_zip
else
    make_kernel
    [ -z "${MODULE}" ] && make_zip
fi
DATE_END="$(date +"%s")"
DIFF="$(bc <<< "${DATE_END} - ${DATE_START}")"

if [ -f zips/"${FINAL_VER}".zip ]; then
    tgm_caesium "Build successful in $(bc <<< "${DIFF} / 60") minute(s) and $(bc <<< "${DIFF} % 60") seconds."
    echoText "Build successful in $(bc <<< "${DIFF} / 60") minute(s) and $(bc <<< "${DIFF} % 60") seconds."
    reportSuccess "${FINAL_VER}".zip
    if [ "${DEVICE}" == "oneplus3" ]; then
        pushcaesiumtg "${FINAL_VER}".zip "${TYPE}"
    fi
fi