#!/usr/bin/env bash

# Copyright (C) Harsh Shandilya <me@msfjarvis.dev>
# SPDX-License-Identifier: GPL-3.0-only

function syncdown() {
  [ -z "${LOCAL_SITE_MIRROR}" ] && {
    echo 'LOCAL_SITE_MIRROR not set!'
    return 1
  }
  local LOCAL_DIR REMOTE_DIR
  declare -a CUSTOM_DIRS=()
  declare -a CONFIGURATION=("-ahv" "--progress" "--delete" "--no-o" "--no-g")
  LOCAL_DIR="${LOCAL_SITE_MIRROR}"
  REMOTE_DIR="${CAESIUM_UPLOAD_PATH/caesium/}"
  for arg; do
    if [ "${arg}" == "--dry-run" ]; then
      CONFIGURATION+=("--dry-run")
    elif [ "${arg}" == "--itemize" ]; then
      CONFIGURATION+=("--itemize-changes")
    else
      local CUSTOM_DIR
      CUSTOM_DIR="$(basename "${arg}")"
      if [ "${CUSTOM_DIR}" == "." ]; then
        CUSTOM_DIR="$(basename "$(pwd)")"
      fi
      [ -d "${LOCAL_SITE_MIRROR}/${CUSTOM_DIR}" ] && CUSTOM_DIRS+=("${CUSTOM_DIR}")
    fi
  done
  if [ "${#CUSTOM_DIRS[@]}" -eq 0 ]; then
    rsync "${CONFIGURATION[@]}" "${CAESIUM_UPLOAD_HOST}:${REMOTE_DIR}/" "${LOCAL_DIR}"
  else
    for dir in "${CUSTOM_DIRS[@]}"; do
      local NEW_LOCAL_DIR NEW_REMOTE_DIR
      NEW_LOCAL_DIR="${LOCAL_DIR}/${dir}"
      NEW_REMOTE_DIR="${REMOTE_DIR}${dir}"
      rsync "${CONFIGURATION[@]}" "${CAESIUM_UPLOAD_HOST}:${NEW_REMOTE_DIR}/" "${NEW_LOCAL_DIR}"
    done
  fi
}

function syncup() {
  [ -z "${LOCAL_SITE_MIRROR}" ] && {
    echo 'LOCAL_SITE_MIRROR not set!'
    return 1
  }
  local LOCAL_DIR REMOTE_DIR
  declare -a CUSTOM_DIRS=()
  declare -a CONFIGURATION=("-ahv" "--progress" "--delete" "--no-o" "--no-g")
  LOCAL_DIR="${LOCAL_SITE_MIRROR}"
  REMOTE_DIR="${CAESIUM_UPLOAD_PATH/caesium/}"
  for arg; do
    if [ "${arg}" == "--dry-run" ]; then
      CONFIGURATION+=("--dry-run")
    elif [ "${arg}" == "--itemize" ]; then
      CONFIGURATION+=("--itemize-changes")
    else
      local CUSTOM_DIR
      CUSTOM_DIR="$(basename "${arg}")"
      if [ "${CUSTOM_DIR}" == "." ]; then
        CUSTOM_DIR="$(basename "$(pwd)")"
      fi
      [ -d "${LOCAL_SITE_MIRROR}/${CUSTOM_DIR}" ] && CUSTOM_DIRS+=("${CUSTOM_DIR}")
    fi
  done
  if [ "${#CUSTOM_DIRS[@]}" -eq 0 ]; then
    rsync "${CONFIGURATION[@]}" "${LOCAL_DIR}/" "${CAESIUM_UPLOAD_HOST}:${REMOTE_DIR}"
  else
    for dir in "${CUSTOM_DIRS[@]}"; do
      local NEW_LOCAL_DIR NEW_REMOTE_DIR
      NEW_LOCAL_DIR="${LOCAL_DIR}/${dir}"
      NEW_REMOTE_DIR="${REMOTE_DIR}${dir}"
      rsync "${CONFIGURATION[@]}" "${NEW_LOCAL_DIR}/" "${CAESIUM_UPLOAD_HOST}:${NEW_REMOTE_DIR}"
    done
  fi
}

function cicnt() {
  mosh "${CAESIUM_UPLOAD_HOST}"
}
